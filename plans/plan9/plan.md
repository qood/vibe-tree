# Claude Code 指示書: VibeTree を「PRD→タスク分解→一括ブランチ/PR作成→進捗可視化→Claude実行」ツールに作り替える（統合1画面）

## 目的（ユーザーのやりたいこと）
- PDMが作ったPRDを起点に、Notion上の要件/タスクをベースにエンジニアがタスク分解する
- そのタスク分解結果から **ブランチを一気に切って、PRを一気に作りたい**
- ブランチ/PRの状況（作業中・CI・レビュー）を **グラフで俯瞰**したい
- 実装は基本 **Claude Code（ターミナル）で回す**
- ただし要件定義/タスク分解のときは **軽い要件定義エリア（チャット/メモ/構造化）**があってもよい
- 画面遷移でコロコロ切り替えない。**1つのメイン画面に統合**して並行進行を見たい

---

## 結論：UI/機能方針（最重要）
- 「Open Chat」は不要。**ターミナル中心**に寄せる
- ただし “要件定義エリア” は残す（チャットというより「PRD/メモ/分解支援」）
- **メイン画面1つ**に、次の3領域を常時出す（折りたたみは可）
  1) ブランチ/PRグラフ領域（俯瞰・クリックで詳細）
  2) タスクツリー/バックログ領域（Notion→分解→確定→一括作成）
  3) 要件定義エリア（PRD貼り付け/Notion取り込み/分解相談）
  4) ターミナル領域（Claude Codeの実行・複数タスク並列ログ）

---

## 実装優先順位（これ以外は後回し）
### Priority S: 「開発が回る最小ループ」を完成させる
1. Notionタスク取り込み（最初はリンク/テキスト貼り付けでもOK）
2. タスク分解（バックログ→ツリー化→確定）
3. **一括ブランチ作成 + 一括PR作成**
4. ブランチ/PRグラフに CI/レビュー状態を反映
5. タスクごとの Claude Code 実行を Web UI で確認（ターミナルログ）

---

## 1) 「Open Chat」を廃止し、要件定義エリアに置換
### 要件
- 現在の “Open Chat” は削除（または機能OFFでUIから消す）
- 代わりに右 or 下に **Requirements Panel** を追加
  - PRD/Notionリンク/メモの貼り付け
  - 分解したタスク案のメモ（構造化して保存）
  - 「分解提案」ボタン（必要ならClaudeに短いプロンプトで相談するが、メインはターミナル実行）

### 保存
- DBに requirements_notes（または既存テーブル流用）として保存
  - project_id / plan_id / content / created_at / updated_at

---

## 2) Notion取り込み（段階実装）
### Phase1（必須・最短）
- Notion API 連携は後回しで良い
- Requirements Panel に
  - Notion URL
  - タスク箇条書きテキスト
  を貼って「タスク化」→ Backlogへ投入できるようにする

### Phase2（後で）
- Notion APIでページ本文取得→見出し/箇条書きをタスク候補に変換

---

## 3) タスクツリー（確定→一括作成）を “迷わない” 形に固定
### 状態
- Draft → Confirmed → Generated を必ず持つ
- UIボタンは固定：
  - 下書き保存
  - 確定（ツリーロック）
  - 一括生成（ブランチ/PR/Worktree）

### ベースブランチ
- main固定は禁止。候補はローカルブランチ一覧から生成
- デフォルトは develop > main > master > 先頭
- repo_settingsに保存して次回以降固定

---

## 4) 一括生成の中身を「ブランチ + PR」に拡張（重要）
### 生成ボタンでやること（順番）
1) タスクツリーを依存順に並べる（親→子）
2) ブランチ名を命名規則で決定（衝突回避）
3) 親ブランチから子ブランチを作成
4) （必要なら）worktree add で作業ディレクトリを作成
5) **gh CLIでPRを一括作成**
   - タイトル: タスク名
   - body: 要件定義メモ/PRDリンク/Done条件/依存関係/Plan概要
   - base: 選択したbase branch or 親タスクブランチ
6) 生成結果（成功/失敗）をタスクごとに記録しUIに表示

### PR作成の要件
- `gh pr create` を使う
- PR URL / number をDBに保存
- 既にPRが存在する場合は再作成せず、URLを取得して紐付ける（idempotent）

---

## 5) 可視化（Branch GraphにCI/レビュー状態を統合）
### グラフのノードに表示する最低限
- branch名
- PR有無/状態（OPEN/MERGED/CLOSED）
- CI状態（pass/fail/running/unknown）
- review状態（approved/changes_requested/pending）
- “作業中（dirty/active）” 状態
- これを **一画面のまま** 更新（ポーリングでも可）

### データ取得
- gh CLIでまとめて取得（N+1しない）
- CIはGitHubのchecks/statusを参照

---

## 6) ターミナル（Claude Code）をメイン体験にする
### 要件
- タスク（ブランチ/PR）ごとに「Run Claude」できる
- Web UI上でログが流れる（ストリーム）
- 複数タスク同時に走っても良い（並列）
- 最初は “実行ログ表示” だけでOK（完全な対話PTYは後回しでもよい）
  - ただし将来的にPTY化できる設計にしておく

### 実行
- worktree_path をcwdにして `claude` を起動
- タスクの要求（実装内容/Done条件/関連ファイル/PRDリンク）をプロンプトに含める
- 実行の開始/終了/失敗をDBに記録

---

## 7) 統合1画面レイアウト（絶対）
- 画面遷移で切り替えない
- 一例（折りたたみ可）：
  - 中央：Branch Graph（俯瞰）
  - 左：Task Tree / Backlog（計画・一括生成）
  - 右（または下）：Requirements Panel（要件定義/PRD/Notion/分解メモ）
  - 下（または右下）：Terminal Panel（Claude実行ログ、タスク別タブ）

---

## Done（受け入れ条件：これができればOK）
- Notionのタスク（または貼り付け）→ Backlog に入る
- Backlog → Tree に分解して確定できる
- 「一括生成」で
  - ブランチが全部作られる
  - PRが全部作られる（URLが紐付く）
- グラフ上でPR/CI/レビュー状態が見える
- タスクごとに Claude Code を走らせ、ログがUIで追える
- すべて **単一メイン画面で完結**する

---

## まず着手するPR（作業順）
1) Open Chat削除 → Requirements Panel追加（保存まで）
2) 一括生成にPR作成を追加（gh pr create）
3) グラフにPR/CI/reviewバッジ追加
4) タスクごとのClaude実行をUIから起動＆ログ表示（並列対応）
